<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<link rel="stylesheet" type="text/css" href="mobile.css" />
		<!--<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />-->
		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

		<title>GPS Locate</title>
		<meta name="description" content="This app allows you to create CSV file for import into HistoryPin.org Website">
		<meta name="author" content="Amy Sorensen">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<link rel="shortcut icon" href="/favicon.ico">
		<link rel="apple-touch-icon" href="/apple-touch-icon.png">
		
		<link rel="stylesheet" type="text/css" href="leaflet-search.css"/>
		<link rel="stylesheet" type="text/css"	href="leaflet-search.mobile.css"/>
	</head>

	<body>
	
		<div>
		<header><h1>Map Locate</h1></header>
		
		<div id="map">
		</div>
		<!--<pre id='output' class='ui-output'></pre>-->
		<p><a href="start.html">Locate Another Photo</a></p>
		<p><a href="ExportCSV.html">Done Adding Photos. Export CSV File</a></p>
		
		<p><button id="storeData" onclick="storeLocation()">Store Location</button></p>
		
		<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3&amp;sensor=false"></script>
		<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
		<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
		
		<script src="leaflet-search.js"></script>
		<script type="text/javascript">
		
		 L.mapbox.accessToken = 'pk.eyJ1IjoiYXJzZ2lzIiwiYSI6IjdmMThhNjU0OWRiYjJkNjBjYTljODk0MDI1NDM1OWViIn0.10Ig1Gc_8WjzqzdtMfWsGA';
		 var geolocate = document.getElementById('geolocate');		 
		 var map = new L.mapbox.map('map', 'mapbox.high-contrast').setView([40,-97], 3);
		 
		 var myLayer = L.mapbox.featureLayer().addTo(map);
		 var output = document.getElementById('output');

		 var geocoder = new google.maps.Geocoder();
   			 
   		 function googleGeocoding(text, callResponse){
			geocoder.geocode({address: text}, callResponse);}

			function filterJSONCall(rawjson){
				var json = {},
				key, loc, disp = [];

				for(var i in rawjson){
				key = rawjson[i].formatted_address;
				loc = L.latLng( rawjson[i].geometry.location.lat(), rawjson[i].geometry.location.lng() );
				json[ key ]= loc;}	//key,value format
				return json;
				}
					
				map.addControl( new L.Control.Search({
			    callData: googleGeocoding,
			    filterJSON: filterJSONCall,
			    markerLocation: false, 
			    autoType: false,
			    autoCollapse: true,
			    minLength: 2,
			    zoom: 10
		    	})
		    	);
						
			function onMapClick(e) {
    				 m = new L.marker(e.latlng,
    				{draggable:true})
    				.addTo(map);
    				result = m.getLatLng();
    				console.log(result);
    				
    				m.on('dragend', function(event) {
    				var m = event.target;  // you could also simply access the marker through the closure
    				result = m.getLatLng();  // but using the passed event is cleaner
    				console.log(result);
					});
				;}
			map.once('click', onMapClick);
			
		function storeLocation(){
 			mx = m.getLatLng();	 	    
 			var XdataToStore = JSON.stringify(mx.lat);
 			var YdataToStore = JSON.stringify(mx.lng);
 			 	    
 			var localNameData = JSON.parse(localStorage.getItem('nameData'));
  			var dataToStore = localNameData+", "+XdataToStore+", "+YdataToStore+"\n";				
		
			//test oneFile for previous data, add new data to
			if (localStorage.getItem('oneFile')===null){
  				localStorage.setItem('oneFile', dataToStore);
  				}else{
  				var keepData = localStorage.getItem('oneFile');
  				localStorage.setItem('oneFile',keepData+dataToStore);
  				}	
  				document.getElementById("storeData").disabled = true;
  				};	
			
				
		</script>
		
		
		
			<footer>
				<p><a id="HOME" href="index.html">Home</a></p>
				<p id="copy">&copy; Copyright Amy Sorensen</p>
				<p><a id="aboutApp" href="about.html">About</a></p>
			</footer>
			
		</div>
	</body>
</html>